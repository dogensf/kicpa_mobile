<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="Ofnt">

	<typeAlias  alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
    <typeAlias  alias="ofnt" type="adminwork.kicpa.ofnt.service.Ofnt"/>
    <typeAlias  alias="ofntVO" type="adminwork.kicpa.ofnt.service.OfntVO"/>
	<typeAlias  alias="comDefaultVO" type="adminwork.com.cmm.ComDefaultVO"/>
			
	<select id="OfntDAO.selectOfntList" parameterClass="ofntVO" resultClass="ofnt">
		<![CDATA[
		SELECT * FROM ( SELECT rownum rn, TB.* FROM (
			SELECT
				a.ofnt_id,
				a.ofnt_sj,
				a.ofnt_cn,
				a.ofnt_no,
				a.sender_id,
				a.sender_nm,
				a.send_dt,
				a.recipient_id,
				a.recipient_nm,
				a.atch_file_id,
			    NVL(b.confirm_yn,'N') AS confirm_yn,
				TO_CHAR(b.confirm_dt, 'YYYY-MM-DD') as confirm_dt,
				a.rdcnt,
				a.del_yn,
				a.reg_id,								
				TO_CHAR(a.reg_dt, 'YYYY-MM-DD') as reg_dt				
			FROM
				CS_OFNOTICE a
				INNER JOIN CS_OFNOTICE_USER b
				on a.ofnt_id = b.ofnt_id and b.recipient_id = #recipient_id#			 
			WHERE 1=1
			and   a.DEL_YN = 'N'
		]]>
			<isNotEmpty property="searchBgnDe">
				AND TO_CHAR(a.reg_dt, 'YYYY-MM-DD') BETWEEN #searchBgnDe# and #searchEndDe#
			</isNotEmpty>
			<isNotEmpty property="searchCnd">
				<isEqual prepend="AND" property="searchCnd" compareValue="0">
					<![CDATA[	a.ofnt_sj||' '||a.sender_nm LIKE '%' || #searchWrd# || '%' 		]]>
				</isEqual>			
				<isEqual prepend="AND" property="searchCnd" compareValue="1">
					<![CDATA[	a.ofnt_sj LIKE '%' || #searchWrd# || '%' 		]]>
				</isEqual>
				<isEqual prepend="AND" property="searchCnd" compareValue="2">
					<![CDATA[	a.sender_nm LIKE '%' || #searchWrd# || '%' 		]]>
				</isEqual>
			</isNotEmpty>	
						
		<![CDATA[			
			ORDER BY a.reg_dt DESC
			) TB ) WHERE rn BETWEEN #firstIndex# + 1 AND #firstIndex# + #recordCountPerPage#
		]]>				
	</select>	
	
	<select id="OfntDAO.selectOfntListCnt" parameterClass="ofntVO" resultClass="java.lang.Integer">
		<![CDATA[
		
			SELECT
				COUNT(a.ofnt_id)				
			FROM
				CS_OFNOTICE a
				INNER JOIN CS_OFNOTICE_USER b
				on a.ofnt_id = b.ofnt_id and b.recipient_id = #recipient_id#			 
			WHERE 1=1
			and   a.DEL_YN = 'N'
		]]>
			<isNotEmpty property="searchBgnDe">
				AND TO_CHAR(a.reg_dt, 'YYYY-MM-DD') BETWEEN #searchBgnDe# and #searchEndDe#
			</isNotEmpty>
			<isNotEmpty property="searchCnd">
				<isEqual prepend="AND" property="searchCnd" compareValue="0">
					<![CDATA[	a.ofnt_sj||' '||a.sender_nm LIKE '%' || #searchWrd# || '%' 		]]>
				</isEqual>			
				<isEqual prepend="AND" property="searchCnd" compareValue="1">
					<![CDATA[	a.ofnt_sj LIKE '%' || #searchWrd# || '%' 		]]>
				</isEqual>
				<isEqual prepend="AND" property="searchCnd" compareValue="2">
					<![CDATA[	a.sender_nm LIKE '%' || #searchWrd# || '%' 		]]>
				</isEqual>
			</isNotEmpty>
						
		<![CDATA[			
			ORDER BY a.reg_dt DESC
		]]>				
	</select>
	
	<update id="OfntDAO.updateOfntConfirm" parameterClass="ofntVO">
 		<![CDATA[
			UPDATE CS_OFNOTICE_USER 
			SET 
				 CONFIRM_YN = 'Y'
				,CONFIRM_DT = SYSDATE
			WHERE  OFNT_ID = #ofnt_id#
			AND   recipient_id = #recipient_id#
			AND  NVL(CONFIRM_YN,'N') = 'N'
 		]]>
 	</update>
	
	<select id="OfntDAO.selectOfnt" parameterClass="ofntVO" resultClass="ofnt" >
		<![CDATA[
		SELECT *
		FROM (
			SELECT
				a.ofnt_id,
				a.ofnt_sj,
				a.ofnt_cn,
				a.ofnt_no,
				a.sender_id,
				a.sender_nm,
				a.send_dt,
				a.recipient_id,
				a.recipient_nm,
				a.atch_file_id,
				a.rdcnt,
				NVL(b.confirm_yn,'N') AS confirm_yn,
				TO_CHAR(b.confirm_dt, 'YYYY-MM-DD') as confirm_dt,
				a.del_yn,
				a.reg_id,								
				TO_CHAR(a.reg_dt, 'YYYY-MM-DD') as reg_dt,
   			      LEAD(a.ofnt_id, 1) OVER (ORDER BY a.reg_dt DESC) AS next_id,
   			      LAG(a.ofnt_id, 1) OVER (ORDER BY a.reg_dt DESC) AS pre_id
			FROM
				CS_OFNOTICE a	
				INNER JOIN CS_OFNOTICE_USER b
				on a.ofnt_id = b.ofnt_id and b.recipient_id = #recipient_id#						
			WHERE 1=1					
		    and a.DEL_YN = 'N'		
		)A
		WHERE 
		     A.OFNT_ID = #ofnt_id#			 		
				
		]]>				
	</select> 
	
	
	
	
	
	
 

</sqlMap>
