<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="MypTrain">

	<typeAlias  alias="EgovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>

	<select id="MypTrainDAO.selectAuditPopupSearchList" parameterClass="HashMap" resultClass="EgovMap">

		<![CDATA[
            SELECT /*+ INDEX( ai PK_AUDIT_INFO_I01 ) */
					ai.AUDIT_CD
				,   ai.KOR_AUD_NM
			FROM AUDIT_INFO ai
			WHERE ai.DEL_YN = 'N'
			AND ai.STATUS_CL = 'A3040010'
			AND ai.AUD_GRP_CL <> 'A3019999'
		]]>
		<isNotEmpty property="searchText">
			<![CDATA[
        		AND ai.KOR_AUD_NM || ai.AUDIT_CD LIKE CONCAT(concat('%' , #searchText#) , '%')
          ]]>
		</isNotEmpty>
		<![CDATA[
			UNION

			SELECT
					ai.AUDIT_CD
				,   ai.KOR_AUD_NM
			FROM AUDIT_INFO ai
			WHERE ai.DEL_YN = 'N'
			AND ai.AUD_GRP_CL = 'A3019999'

		]]>
		<isNotEmpty property="searchText">
			<![CDATA[
        		AND ai.KOR_AUD_NM || ai.AUDIT_CD LIKE CONCAT(concat('%' , #searchText#) , '%')
          ]]>
		</isNotEmpty>
	</select>

	<select id="MypTrainDAO.selectMypCpaTrainRegisterRegFlagInfo" parameterClass="HashMap" resultClass="String">

		<![CDATA[
            SELECT
					acm.APNTC_SN
			FROM APNTC_CPA_MYP acm
			WHERE acm.APNTC_SN = (SELECT MAX(APNTC_SN) FROM APNTC_CPA_MYP WHERE PIN = #pin#)
			  AND acm.REG_FLAG='N'
		]]>
	</select>
	
	<insert id="MypTrainDAO.mypCpaTrainRegisterAgreeSave" parameterClass="HashMap">

		<selectKey keyProperty="mypApntcSn" resultClass="int">
			SELECT NVL(MAX(APNTC_SN), 0) + 1 FROM APNTC_CPA_MYP
		</selectKey>

		<![CDATA[

			MERGE INTO APNTC_CPA_MYP
                USING DUAL
                ON (PIN = #pin# AND APNTC_SN = #apntcSn#)
                WHEN MATCHED THEN
                          UPDATE SET
                          AGREE_INFO_YN = #agreeInfoYn#, KOREAN_NM = #koreanNm#, BRTHDY = #brthdy#,
                          LAST_UPDT_ID = #userId#, LAST_UPDT_DT = SYSTIMESTAMP

                WHEN NOT MATCHED THEN
                          INSERT (APNTC_SN, PIN, AGREE_INFO_YN, KOREAN_NM, BRTHDY,
                          		FRST_REGIST_ID, FRST_REGIST_DT, LAST_UPDT_ID, LAST_UPDT_DT)

                          VALUES (#mypApntcSn#, #pin#, #agreeInfoYn#, #koreanNm#, #brthdy#,
		        				#userId#, SYSTIMESTAMP, #userId#, SYSTIMESTAMP)

		]]> 
	</insert>

	<update id="MypTrainDAO.mypCpaTrainRegisterPictInfoSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_CPA_MYP
            SET
                PICT_FILE_ID = #pictFileId#
            ,   LAST_UPDT_ID = #userId#
            ,   LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#

		]]>
	</update>

	<update id="MypTrainDAO.mypCpaTrainRegisterGrdtSatausInfoSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_CPA_MYP
            SET
                VACATION_STR_DE = #vacationStrDe#
			,   VACATION_END_DE = #vacationEndDe#
			,   GRDT_SATAUS = #grdtSataus#
			,   GRDT_DE = #grdtDe#
            ,   LAST_UPDT_ID = #userId#
            ,   LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#

		]]>
	</update>

	<update id="MypTrainDAO.mypCpaTrainRegisterApntcCpaHistInfoSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_CPA_MYP
            SET
				APP_REGIST_DE = #appRegistDe#,
				GUIDE_CPA_NM = #guideCpaNm#,
				GUIDE_CPA_NO = #guideCpaNo#,
				APP_INSTT_NM = #appInsttNm#,
				APP_INSTT_CD = #appInsttCd#,
				APNTC_CL = #apntcCl#,
        ]]>
		<isNotEmpty property="appInsttEtcYn">
			<![CDATA[
           APP_INSTT_ETC_YN = #appInsttEtcYn#,
          ]]>
		</isNotEmpty>
		<isNotEmpty property="appInsttEtc">
			<![CDATA[
           APP_INSTT_ETC = #appInsttEtc#,
          ]]>
		</isNotEmpty>

		<![CDATA[
               LAST_UPDT_ID = #userId#,
               LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#
		]]>

	</update>

	<update id="MypTrainDAO.mypCpaTrainRegisterAtchFileIdSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_CPA_MYP
            SET
        ]]>
		<isNotEmpty property="atchFileId1">
			<![CDATA[
           ATCH_FILE_ID1 = #atchFileId1#,
          ]]>
		</isNotEmpty>
		<isNotEmpty property="atchFileId2">
			<![CDATA[
           ATCH_FILE_ID2 = #atchFileId2#,
          ]]>
		</isNotEmpty>
		<isNotEmpty property="atchFileId3">
			<![CDATA[
           ATCH_FILE_ID3 = #atchFileId3#,
          ]]>
		</isNotEmpty>
		<isNotEmpty property="atchFileId4">
			<![CDATA[
           ATCH_FILE_ID4 = #atchFileId4#,
          ]]>
		</isNotEmpty>
		<isNotEmpty property="passCrtiFileId">
			<![CDATA[
           PASS_CRTI_FILE_ID = #passCrtiFileId#,
          ]]>
		</isNotEmpty>
		<isNotEmpty property="emplCrtiFileId">
			<![CDATA[
           EMPL_CRTI_FILE_ID = #emplCrtiFileId#,
          ]]>
		</isNotEmpty>
		<isNotEmpty property="rsumFileId">
			<![CDATA[
           RSUM_FILE_ID = #rsumFileId#,
           EVENTN = #eventn#,
          ]]>
		</isNotEmpty>

        <![CDATA[
               LAST_UPDT_ID = #userId#,
               LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#
		]]>

	</update>

	<update id="MypTrainDAO.mypCpaTrainRegisterRegFlagSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_CPA_MYP
            SET
       			REG_FLAG = #regFlag#,
               	LAST_UPDT_ID = #userId#,
               	LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#
		]]>

	</update>

	<select id="MypTrainDAO.selectCpaTrainRegistReviewInfoList" parameterClass="HashMap" resultClass="EgovMap">

		<![CDATA[
            SELECT
            		acm.APNTC_SN
            	,	acm.PIN
				,	acm.AGREE_INFO_YN
				,	acm.PICT_FILE_ID
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.PICT_FILE_ID =ld.ATCH_FILE_ID) AS PICT_FILE_NM
				,	TO_CHAR(TO_DATE(acm.VACATION_STR_DE),'YYYY-MM-DD') AS VACATION_STR_DE
				,	TO_CHAR(TO_DATE(acm.VACATION_END_DE),'YYYY-MM-DD') AS VACATION_END_DE
				,	acm.GRDT_SATAUS
				,   CASE WHEN acm.GRDT_SATAUS = '00000010' THEN '졸업 또는 미재학' ELSE '재학중' END AS GRDT_SATAUS_NM
				,	TO_CHAR(TO_DATE(acm.GRDT_DE),'YYYY-MM-DD') AS GRDT_DE
				,	TO_CHAR(TO_DATE(acm.APP_REGIST_DE),'YYYY-MM-DD') AS APP_REGIST_DE
				,	acm.GUIDE_CPA_NM
				,	acm.GUIDE_CPA_NO
				,	acm.APP_INSTT_NM
				,	acm.APP_INSTT_CD
				,	acm.APP_INSTT_ETC_YN
				,	acm.APP_INSTT_ETC
				,	acm.APNTC_CL
				,	acm.ATCH_FILE_ID1
				,	acm.ATCH_FILE_ID2
				,	acm.ATCH_FILE_ID3
				,	acm.ATCH_FILE_ID4
				,	acm.PASS_CRTI_FILE_ID
				,	acm.EMPL_CRTI_FILE_ID
				,	acm.RSUM_FILE_ID
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.ATCH_FILE_ID1 =ld.ATCH_FILE_ID) AS ATCH_FILE_ID1_NM
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.ATCH_FILE_ID2 =ld.ATCH_FILE_ID) AS ATCH_FILE_ID2_NM
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.ATCH_FILE_ID3 =ld.ATCH_FILE_ID) AS ATCH_FILE_ID3_NM
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.ATCH_FILE_ID4 =ld.ATCH_FILE_ID) AS ATCH_FILE_ID4_NM
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.PASS_CRTI_FILE_ID =ld.ATCH_FILE_ID) AS PASS_CRTI_FILE_ID_NM
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.EMPL_CRTI_FILE_ID =ld.ATCH_FILE_ID) AS EMPL_CRTI_FILE_ID_NM
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE acm.RSUM_FILE_ID =ld.ATCH_FILE_ID) AS RSUM_FILE_ID_NM
				,	acm.EVENTN
				,	acm.REG_FLAG
				,   TO_CHAR(acm.FRST_REGIST_DT, 'YYYY-MM-DD') AS FRST_REGIST_DT
				,	acm.REJECT_RSN
				,	acm.REMARK

            FROM APNTC_CPA_MYP acm
            WHERE acm.APNTC_SN = (SELECT MAX(APNTC_SN) FROM APNTC_CPA_MYP WHERE PIN = #pin#
        ]]>
		<isNotEmpty property="regFlag">
			<![CDATA[
                AND REG_FLAG = #regFlag#
            ]]>
		</isNotEmpty>
		<![CDATA[
			)
		]]>

	</select>

	<select id="MypTrainDAO.selectApntcCpaHistGuideCpaCehck" parameterClass="HashMap" resultClass="int">

		<![CDATA[
            SELECT COUNT(*)
            FROM CPA c
            LEFT JOIN MBER_INDVDLINFO mi on mi.PIN = c.PIN
            WHERE c.CPA_ID = #guideCpaNo#
              AND mi.KOREAN_NM = #guideCpaNm#
              and c.CANCL_CL is null
         ]]>

	</select>

	<update id="MypTrainDAO.updateCpaPassMemPict" parameterClass="HashMap">
		<![CDATA[

			UPDATE MBER_PHOTO
            SET
                LAST_YN ='Y',
                LAST_UPDT_ID = #userId#,
                LAST_UPDT_DT = SYSTIMESTAMP
            WHERE
                PTG_TRG_ID = #pin#
            AND LAST_YN = 'N'

		]]>
	</update>

	<insert id="MypTrainDAO.insertCpaPassMemPict" parameterClass="HashMap">
		<![CDATA[

			INSERT INTO MBER_PHOTO(
		        PTG_SN,
		        PTG_TRG_ID,
		        ATCH_FILE_ID,
		        LAST_YN,
		        FRST_REGIST_ID,
		        FRST_REGIST_DT,
		        LAST_UPDT_ID,
		        LAST_UPDT_DT
		    )
		    VALUES
		    (   KIPADM.MBER_PHOTO_SEQ.NEXTVAL,
		        #pin#,
		        #pictFileId#,
		        #lastYn#,
		        #userId#,
		        SYSTIMESTAMP,
		        #userId#,
		        SYSTIMESTAMP
		    )

		]]>
	</insert>

</sqlMap>
