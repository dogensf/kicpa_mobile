<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="MypAudTrain">

	<typeAlias  alias="EgovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>



	<select id="MypAudTrainDAO.selectMypCpaAudTrainRegisterRegFlagInfo" parameterClass="HashMap" resultClass="String">

		<![CDATA[
            SELECT
					aacm.APNTC_SN
			FROM APNTC_AUD_CPA_MYP aacm
			WHERE aacm.APNTC_SN = (SELECT MAX(APNTC_SN) FROM APNTC_AUD_CPA_MYP WHERE PIN = #pin#)
			  AND aacm.REG_FLAG='N'
		]]>
	</select>

	<insert id="MypAudTrainDAO.mypCpaAudTrainRegisterAgreeSave" parameterClass="HashMap">

		<selectKey keyProperty="mypApntcSn" resultClass="int">
			SELECT NVL(MAX(APNTC_SN), 0) + 1 FROM APNTC_AUD_CPA_MYP
		</selectKey>

		<![CDATA[

			MERGE INTO APNTC_AUD_CPA_MYP
                USING DUAL
                ON (PIN = #pin# AND APNTC_SN = #apntcSn#)
                WHEN MATCHED THEN
                          UPDATE SET
                          AGREE_INFO_YN = #agreeInfoYn#, KOREAN_NM = #koreanNm#, BRTHDY = #brthdy#,
                          LAST_UPDT_ID = #userId#, LAST_UPDT_DT = SYSTIMESTAMP

                WHEN NOT MATCHED THEN
                          INSERT (APNTC_SN, PIN, AGREE_INFO_YN, KOREAN_NM, BRTHDY,
                          		FRST_REGIST_ID, FRST_REGIST_DT, LAST_UPDT_ID, LAST_UPDT_DT)

                          VALUES (#mypApntcSn#, #pin#, #agreeInfoYn#, #koreanNm#, #brthdy#,
		        				#userId#, SYSTIMESTAMP, #userId#, SYSTIMESTAMP)

		]]>
	</insert>

	<update id="MypAudTrainDAO.mypCpaAudTrainRegisterApntcCpaHistInfoSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_AUD_CPA_MYP
            SET
				AUD_REGIST_DE = #audRegistDe#,
				GUIDE_CPA_NM = #guideCpaNm#,
				GUIDE_CPA_NO = #guideCpaNo#,
				APP_INSTT_NM = #appInsttNm#,
				APP_INSTT_CD = #appInsttCd#,
				APNTC_CL = #apntcCl#,
               	LAST_UPDT_ID = #userId#,
               	LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#
		]]>

	</update>

	<update id="MypAudTrainDAO.mypCpaAudTrainRegisterAtchFileIdSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_AUD_CPA_MYP
            SET
            	EMPL_CRTI_FILE_ID = #emplCrtiFileId#,
				RSUM_FILE_ID = #rsumFileId#,
				EVENTN = #eventn#,
        ]]>
		<isNotEmpty property="atchFileId">
			<![CDATA[
           ATCH_FILE_ID = #atchFileId#,
          ]]>
		</isNotEmpty>

		<![CDATA[
               LAST_UPDT_ID = #userId#,
               LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#
		]]>

	</update>

	<select id="MypAudTrainDAO.selectCpaAudTrainRegistReviewInfoList" parameterClass="HashMap" resultClass="EgovMap">

		<![CDATA[
            SELECT
            		PIN
				,	AGREE_INFO_YN
				,	TO_CHAR(TO_DATE(AUD_REGIST_DE),'YYYY-MM-DD') AS AUD_REGIST_DE
				,	GUIDE_CPA_NM
				,	GUIDE_CPA_NO
				,	APP_INSTT_NM
				,	APP_INSTT_CD
				,	APNTC_CL
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE EMPL_CRTI_FILE_ID =ld.ATCH_FILE_ID) AS EMPL_CRTI_FILE_ID
				,	(SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE RSUM_FILE_ID =ld.ATCH_FILE_ID) AS RSUM_FILE_ID
				,   CASE WHEN aacm.ATCH_FILE_ID IS NOT NULL THEN (SELECT ld.ORIGNL_FILE_NM FROM LETTNFILEDETAIL ld WHERE aacm.ATCH_FILE_ID =ld.ATCH_FILE_ID) ELSE '' END AS ATCH_FILE_ID
				,	REG_FLAG
				,   TO_CHAR(aacm.FRST_REGIST_DT, 'YYYY-MM-DD') AS FRST_REGIST_DT
				,	REJECT_RSN
				,	REMARK

            FROM APNTC_AUD_CPA_MYP aacm
            WHERE aacm.APNTC_SN = (SELECT MAX(APNTC_SN) FROM APNTC_AUD_CPA_MYP WHERE PIN = #pin#
        ]]>
		<isNotEmpty property="regFlag">
			<![CDATA[
                AND REG_FLAG = #regFlag#
            ]]>
		</isNotEmpty>
		<![CDATA[
			)
		]]>

	</select>

	<update id="MypAudTrainDAO.mypCpaAudTrainRegisterRegFlagSave" parameterClass="HashMap">
		<![CDATA[

			UPDATE APNTC_AUD_CPA_MYP
            SET
       			REG_FLAG = #regFlag#,
               	LAST_UPDT_ID = #userId#,
               	LAST_UPDT_DT = SYSTIMESTAMP

            WHERE PIN = #pin#
              AND APNTC_SN = #apntcSn#
		]]>

	</update>

</sqlMap>
